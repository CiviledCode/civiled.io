<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  xml:lang="en-us" lang="en-us" >

<head>
    










    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.19376a73756a32b5aba91ad145ae75960d5f0bc999eb3f100b6b4e912b707015.js"></script>






    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playwrite+CU:wght@100..400&display=swap" rel="stylesheet">

    
    <link rel="icon" href=/favicon.png>

    
    





  





  
  
  


<!-- Open Graph image and Twitter Card metadata -->

<title itemprop="name">Civiled - Heap Exploitation</title>
<meta property="og:title" content=Civiled&#32;-&#32;Heap&#32;Exploitation />
<meta name="twitter:title" content=Civiled&#32;-&#32;Heap&#32;Exploitation />
<meta itemprop="name" content=Civiled&#32;-&#32;Heap&#32;Exploitation />
<meta name="application-name" content=Civiled&#32;-&#32;Heap&#32;Exploitation />
<meta property="og:site_name" content="Civiled" />


<meta name="description" content="Pwn Heap Exploitation Tricks and Tips" />
<meta itemprop="description" content="Pwn Heap Exploitation Tricks and Tips" />
<meta property="og:description" content="Pwn Heap Exploitation Tricks and Tips" />
<meta name="twitter:description" content="Pwn Heap Exploitation Tricks and Tips" />


<base href="https://civiled.io/notes/heap/" />
<link rel="canonical" href="https://civiled.io/notes/heap/" itemprop="url" />
<meta name="url" content="https://civiled.io/notes/heap/" />
<meta name="twitter:url" content="https://civiled.io/notes/heap/" />
<meta property="og:url" content="https://civiled.io/notes/heap/" />


<meta property="og:updated_time" content="2024-09-01T00:00:00Z" />


<link rel="sitemap" type="application/xml" title="Sitemap" href='https://civiled.io/sitemap.xml' />

<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />



  
    <meta name="twitter:site" content="@josh_gallas" />
    <meta name="twitter:creator" content="@josh_gallas" />

<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="Civiled" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.92.2" />


    
    

<link type="text/css" rel="stylesheet" href="/css/bundle.min.263097e8bc0533444eb85a324663ec769631b90133f16622f641d5b511934728.css">


    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #d12f24;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5a5a5a;
        --link-color: #268bd2;
        --date-color: #515151;
        --table-border-color: #E5E5E5;
        --table-stripe-color: #F9F9F9;
        --code-color: #000;
        --code-background-color: #E5E5E5;
        --code-block-color: #fff;
        --code-block-background-color: #272822;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #EEE;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9D9D9D;
        --link-color: #d12f24;
        --date-color: #9A9A9A;
        --table-border-color: #515151;
        --table-stripe-color: #202020;
        --code-color: #FFF;
        --code-background-color: #d12f24;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>

</head>
    <body class="dark-theme">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        
        <div class="sidebar-about">
    <h1 class="brand">
        
            <a href="https://civiled.io/">
                <img src="/images/logo.png" alt="brand image">
            </a>
        
        
            <a href="https://civiled.io/">
                <h1 class="brand-name">Civiled</h1>
            </a>
        
    </h1>
    <p class="lead">
    
    </p>
</div>

        <nav>
    <ul class="sidebar-nav">

        
        
        
        
            

            
                
                
            
                
                
            
                
                
                    <li class="heading">
                        <a href="/notes/">Notes</a>
                    </li>
                    
                
            
                
                
            
            
                
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
            
                
                
            
                
                
                    <li class="heading">
                        <a href="/writeups/">Writeups</a>
                    </li>
                    
                
            
            
                
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
                    <li class="heading">
                        <a href="/blogs/">Blogs</a>
                    </li>
                    
                
            
                
                
            
                
                
            
            
                
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        

    </ul>
</nav>

        <div class="social-holder">
    
    <a target="_blank" class="social" title="GitHub" href="https://github.com/CiviledCode">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24">
            <path fill="currentColor"
                d="M18.88 1.099C18.147.366 17.265 0 16.233 0H3.746C2.714 0 1.832.366 1.099 1.099C.366 1.832 0 2.714 0 3.746v12.487c0 1.032.366 1.914 1.099 2.647c.733.733 1.615 1.099 2.647 1.099H6.66c.19 0 .333-.007.429-.02a.504.504 0 0 0 .286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555 0 0 1-.904-.091a2.026 2.026 0 0 1-.872-.39a1.651 1.651 0 0 1-.572-.8l-.13-.3a3.25 3.25 0 0 0-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956 0 0 1-.17-.156a.723.723 0 0 1-.117-.182c-.026-.061-.004-.111.065-.15c.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1 0 0 1 .631.677c.2.355.44.626.722.813c.282.186.566.28.852.28c.286 0 .533-.022.742-.065a2.59 2.59 0 0 0 .585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907 0 0 1-1.333-.234a5.314 5.314 0 0 1-1.223-.507a3.5 3.5 0 0 1-1.047-.872c-.277-.347-.505-.802-.683-1.365c-.177-.564-.266-1.215-.266-1.952c0-1.049.342-1.942 1.027-2.68c-.32-.788-.29-1.673.091-2.652c.252-.079.625-.02 1.119.175c.494.195.856.362 1.086.5c.23.14.414.257.553.352a9.233 9.233 0 0 1 2.497-.338c.859 0 1.691.113 2.498.338l.494-.312a6.997 6.997 0 0 1 1.197-.572c.46-.174.81-.221 1.054-.143c.39.98.424 1.864.103 2.653c.685.737 1.028 1.63 1.028 2.68c0 .737-.089 1.39-.267 1.957c-.177.568-.407 1.023-.689 1.366a3.65 3.65 0 0 1-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9 0 0 1-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36 0 0 0 .208.189c.096.034.18.056.254.064c.074.01.18.013.318.013h2.914c1.032 0 1.914-.366 2.647-1.099c.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z" />
        </svg>
    </a>
    
    
    
    <a target="_blank" class="social" title="LinkedIn" href="https://www.linkedin.com/in/joshua-gallas-a934b0201/">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 448 512">
            <path fill="currentColor"
                d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5c0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7c-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5c67.2 0 79.7 44.3 79.7 101.9V416z" />
        </svg>
    </a>
    
    
    
    <a target="_blank" class="social" title="X" href="https://x.com/josh_gallas">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.1em" height="1.1em" viewBox="0 0 512 472.799">
            <path fill="currentColor"
                d="M403.229 0h78.506L310.219 196.04 512 462.799H354.002L230.261 301.007 88.669 462.799h-78.56l183.455-209.683L0 0h161.999l111.856 147.88L403.229 0zm-27.556 415.805h43.505L138.363 44.527h-46.68l283.99 371.278z" />
        </svg>
    </a>
    
    
    
    
    
    <a target="_blank" class="social" title="Discord" href="https://discordapp.com/users/337082914124726282">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 24 24">
            <path fill="currentColor"
                d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4a.09.09 0 0 0-.07.03c-.18.33-.39.76-.53 1.09a16.09 16.09 0 0 0-4.8 0c-.14-.34-.35-.76-.54-1.09c-.01-.02-.04-.03-.07-.03c-1.5.26-2.93.71-4.27 1.33c-.01 0-.02.01-.03.02c-2.72 4.07-3.47 8.03-3.1 11.95c0 .02.01.04.03.05c1.8 1.32 3.53 2.12 5.24 2.65c.03.01.06 0 .07-.02c.4-.55.76-1.13 1.07-1.74c.02-.04 0-.08-.04-.09c-.57-.22-1.11-.48-1.64-.78c-.04-.02-.04-.08-.01-.11c.11-.08.22-.17.33-.25c.02-.02.05-.02.07-.01c3.44 1.57 7.15 1.57 10.55 0c.02-.01.05-.01.07.01c.11.09.22.17.33.26c.04.03.04.09-.01.11c-.52.31-1.07.56-1.64.78c-.04.01-.05.06-.04.09c.32.61.68 1.19 1.07 1.74c.03.01.06.02.09.01c1.72-.53 3.45-1.33 5.25-2.65c.02-.01.03-.03.03-.05c.44-4.53-.73-8.46-3.1-11.95c-.01-.01-.02-.02-.04-.02zM8.52 14.91c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.84 2.12-1.89 2.12zm6.97 0c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.83 2.12-1.89 2.12z" />
        </svg>
    </a>
    
    
    
    
    
    
    
    
    
    
    <a target="_blank" class="social" title="Email" href="mailto://civiled@usa.com">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 485.211 485.211">
            <path fill="currentColor"
                d="M301.393,241.631L464.866,424.56H20.332l163.474-182.928l58.801,51.443L301.393,241.631z M462.174,60.651H23.027 l219.579,192.142L462.174,60.651z M324.225,221.67l160.986,180.151V80.792L324.225,221.67z M0,80.792v321.029L160.972,221.64 L0,80.792z" />
        </svg>
    </a>
    
    
    
</div>
        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | forked from <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post">
  <div class="info">
  <h1 class="post-title">
    <a href="https://civiled.io/notes/heap/">Heap Exploitation</a>
  </h1>

  <div class="headline">
    <div>
      
      
      <time datetime=" 2024-09-01T00:00:00Z" class="post-date">
        September 1, 2024
      </time>
      
      <span> - </span>
      <span class="reading-time">
        
          
        

        <span>5 mins read</span>
      </span>
    </div>

    
    <ul class="tags">
      
      <li class="tag-heapexp">
        <a href="https://civiled.io/tags/heapexp">heapexp</a>
      </li>
      
      <li class="tag-technique">
        <a href="https://civiled.io/tags/technique">technique</a>
      </li>
      
      <li class="tag-read">
        <a href="https://civiled.io/tags/read">read</a>
      </li>
      
      <li class="tag-write">
        <a href="https://civiled.io/tags/write">write</a>
      </li>
      
      <li class="tag-execute">
        <a href="https://civiled.io/tags/execute">execute</a>
      </li>
      
      <li class="tag-pwn">
        <a href="https://civiled.io/tags/pwn">pwn</a>
      </li>
      
    </ul>
    
  </div>

  
  

  
</div>

  <p>The Heap is a data structure that exists to manage dynamic memory allocations. There exists multiple implementations of the heap.</p>
<h2 id="glibc-heap">Glibc Heap</h2>
<p>The glibc heap implementation works by exposing various functions that work off of two fundamental ideologies: allocating and freeing memory. When memory is needed, an allocate instruction is used to retrieve a location in memory that data can be stored at. When that data is no longer needed, the programmer can free it back to the heap to be reused for future allocations.</p>
<p>When memory is allocated, it&rsquo;s returning memory location is 8 byte alligned on 32-bit systems and 16 byte alligned on 64-bit systems. The value returned is a pointer to a location of memory that holds the data. This data is contained inside of a struct called a chunk. Surrounding the data contains metadata about the chunk, so if before or after the region returned by malloc can be written, then there exists attack vectors.</p>
<p>The chunk structure is below:</p>
<pre tabindex="0"><code>| size      | 
| data      |
| prev_size |

size c b a
     4 2 1   

size is the size of the chunk. The lower 3 bvits are reserved to flags:
    a 1 if previous chunk in use
    b 1 if mmaped chunk
    c 0 if comes from main arena and main heap

prev_size is size of the 
</code></pre><p>When free is called, the address to the start of the chunk is computed from the address supplied. Then there are checks to ensure that the memory at that location can be written to and such. If so, the data section of the chunk is populated with some additional metadata that allows it to be a part of a &ldquo;bin&rdquo;. Below is the structure inside data:</p>
<pre tabindex="0"><code>| fwd_ptr       |
| bck_ptr       |
| fwd_next_size |
| bck_next_size |
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> malloc_chunk {

  INTERNAL_SIZE_T      mchunk_prev_size;  <span style="color:#75715e">/* Size of previous chunk (if free).  */</span>
  INTERNAL_SIZE_T      mchunk_size;       <span style="color:#75715e">/* Size in bytes, including overhead. */</span>

  <span style="color:#66d9ef">struct</span> malloc_chunk<span style="color:#f92672">*</span> fd;         <span style="color:#75715e">/* double links -- used only if free. */</span>
  <span style="color:#66d9ef">struct</span> malloc_chunk<span style="color:#f92672">*</span> bk;

  <span style="color:#75715e">/* Only used for large blocks: pointer to next larger size.  */</span>
  <span style="color:#66d9ef">struct</span> malloc_chunk<span style="color:#f92672">*</span> fd_nextsize; <span style="color:#75715e">/* double links -- used only if free. */</span>
  <span style="color:#66d9ef">struct</span> malloc_chunk<span style="color:#f92672">*</span> bk_nextsize;
};
</code></pre></div><p>These fields exist to allow them to be a part of a bin. Bins represent a double linked list, so the <code>fwd</code> and <code>bck</code> pointers point to the next and previous elements in the bin respectively. Each bin holds chunks of similar size.</p>
<p>There exists 5 primary bins:</p>
<ul>
<li>Fast</li>
<li>Small</li>
<li>Large</li>
<li>Unsorted</li>
<li>Tcache</li>
</ul>
<p>There exists an array that holds the starting chunk for each bin. This allows the pointer to the start for a given sized bin to be easily obtained.</p>
<p>There are 62 small bins. There exists a bin from 16-504 bytes where every 8 bytes is a new fastbin on 32 bit, 16-1028 bytes where every 16 bytes is a new fastbin on 64 bit.</p>
<p>There are 63 large bins. Large bins store allocations that are at least 512 bytes(32 bit), 1028 bytes(64 bit), and hold allocations that are within ranges rather than specific sizes.</p>
<p>Unsorted bin is a single bin that allows the heap manager to skip on having to put the chunk inside it&rsquo;s respective fast bin. If some memory is freed and then shortly after memory that is of the same size or less is allocated, then the unsorted bin can reuse these chunks. Additionally, if a allocation request comes in and none of the chunks in the unsorted bin are large enough to suffice it, then the chunks in the unsorted bin are moved to their respective small/large bins.</p>
<p>There are 10 fast bins. Fast bins are similar to small bins in the regard that they are spaced out and hold specific sizes, but freed chunks in fast bins aren&rsquo;t subject to consolidation immediately. As such, fast bins only need to be singly linked. Adjacent fast bin chunks will be consolidated and added to the unsorted bin when an allocation for a chunk size that fast bins can&rsquo;t hold is requested.</p>
<p>Tcache bin ???</p>
<p>When a chunk is requested to be allocated, the following order is checked to find a chunk:</p>
<ol>
<li>Check tchache if size corresponds to a tchache bin.</li>
<li>If request is too big, mmap location.</li>
<li>If a fast bin exists, use a chunk from inside there.</li>
<li>If a small bin exists, use a chunk from inside there.</li>
<li>Consolidate the fast bins and check for unsorted bins that suffice.</li>
<li>If a large bin exists, use a chunk from inside there.</li>
<li>Create a new chunk from scratch.</li>
<li>Return null.</li>
</ol>
<p>Creating a chunk from scratch:</p>
<ol>
<li>Create chunk from top of heap.</li>
<li>If not enough space, extend heap with <code>sbrk</code></li>
<li>Use mmap to create new chunk.</li>
</ol>
<p>When a chunk is freed:</p>
<ol>
<li>If it fits in a tcache bin, put it in there.</li>
<li>Check the chunk metadata bits and if it was constructed with mmap, then give the unmap the chunk with munmap.</li>
<li>If it fits in a fastbin, put it in there.</li>
<li>If the size exceeds size for fast, small, and large bins, immediately place in unsorted bin.</li>
<li>Merge with neighbouring chunks that exist in small, large, and unsorted bins.</li>
<li>If chunk exists at the top of the heap, merge that with the heap instead of storing it in a bin.</li>
<li>Store in unsorted bin.</li>
</ol>
<h2 id="musl-heap">Musl Heap</h2>
<p><em>coming soon</em></p>
<h2 id="resources">Resources</h2>
<ul>
<li><a href="https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/" target="_blank">https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/</a></li>
<li><a href="https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/" target="_blank">https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/</a></li>
<li><a href="https://elixir.bootlin.com/glibc/glibc-2.28/source/malloc/malloc.c#L1044" target="_blank">https://elixir.bootlin.com/glibc/glibc-2.28/source/malloc/malloc.c#L1044</a></li>
<li><a href="https://pwn.college/software-exploitation/dynamic-allocator-misuse" target="_blank">https://pwn.college/software-exploitation/dynamic-allocator-misuse</a></li>
</ul>

  
  <hr>
<div class="footer">
    
	    
            <a class="previous-post" href="https://civiled.io/notes/shellcode/?ref=footer"><span style="font-weight:bold;">« Previous</span><br>Shellcoding</a>
        
	    
            <div class="next-post">
                <a href="https://civiled.io/notes/radare2/?ref=footer"><span style="font-weight:bold;">Next »</span><br>Radare2</a>
            </div>
        
    
</div>

  
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#glibc-heap">Glibc Heap</a></li>
    <li><a href="#musl-heap">Musl Heap</a></li>
    <li><a href="#resources">Resources</a></li>
  </ul>
</nav>
    </div>
</div>

  

        </div>
    </body>
</html>
